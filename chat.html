<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Hương Quế</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=ww5IVhWH"></script>
    <style>
      /* CSS cho popup */
      .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 20px;
        z-index: 1000;
      }
      .popup.show {
        display: block;
      }
      .popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        z-index: 999;
      }
      .popup-overlay.show {
        display: block;
      }

      /* Typing loader animation */
      .typing-container {
        display: flex;
        align-items: center;
        font-style: italic;
        color: #555;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        background-color: #555;
        border-radius: 50%;
        margin: 0 2px;
        animation: typingDot 1.5s infinite ease-in-out;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      .suggestions {
        background: white;
        max-height: auto;
        overflow-y: auto;
      }
      .suggestion-item {
        padding: 10px;
        cursor: pointer;
      }
      .suggestion-item:hover {
        background-color: #f0f0f0;
      }

      @keyframes typingDot {
        0%,
        100% {
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <main
      id="app"
      class="relative min-h-screen py-8 bg-gray-100 sm:px-6 sm:p-8 bg-background"
      style="
        background-image: url(/image/bg-red.jpg);
        background-position: center;
        background-repeat: repeat; /* Lặp lại hình ảnh */
        background-size: auto; /* Hoặc có thể sử dụng 'auto' */
      "
    >
      <div class="p-2 bg-white rounded-full w-fit">
        <button class="flex" @click="handleBack">
          <img src="/image/back-svgrepo-com.svg" alt="" class="w-8 pr-2" />
          <p>Quay lại</p>
        </button>
      </div>
      <!-- Hình ảnh bên trái -->
      <!-- <div class="fixed left-0 top-0 h-full w-[0%] sm:w-1/6 md:w-1/5 xl:w-1/4">
        <img
          src="./image/sanphamHQ1.jpg"
          alt="Left Image"
          class="object-cover w-full h-full"
        />
      </div> -->
      <!-- Nội dung chính -->
      <div
        class="max-w-2xl mx-auto relative w-[100%] sm:w-[50%] md:w-[60%] lg:w-[60%] xl:w-[80%]"
      >
        <div class="relative px-2">
          <div class="flex items-center justify-center mb-4">
            <h1
              class="w-[80%] sm:w-[100%] text-3xl font-bold text-center pr-2 text-white"
            >
              AI Hương Quế
            </h1>
            <img
              class="w-14 h-14"
              src="./image/logoHQ.png"
              alt="ChatGPT Icon"
            />
          </div>
          <!-- Button cài đặt -->
          <!-- <button
            @click="toggleSettingsPopup"
            class="absolute p-2 text-gray-500 top-4 right-4 hover:text-gray-700"
            aria-label="Cài đặt"
          >
            <i class="fas fa-cog fa-lg"></i>
          </button> -->

          <div class="p-1 bg-white rounded-lg shadow sm:p-6">
            <div class="flow-root">
              <div class="mt-2 mb-2 sm:mt-4">
                <!-- Chat Messages -->
                <ul>
                  <li
                    class="py-3 sm:py-4"
                    v-for="message in messages"
                    :key="message.id"
                  >
                    <div
                      class="flex items-start gap-4"
                      :class="messageClasses(message.role)"
                    >
                      <div
                        v-if="message.role === 'user'"
                        class="relative p-2 break-normal whitespace-pre-line bg-gray-100 rounded-lg shadow-md sm:p-4"
                      >
                        <span v-if="message.role === 'user'" class="font-bold"
                          >Bạn:</span
                        >
                        {{ message.content }}
                      </div>
                      <div
                        v-if="message.role === 'assistant'"
                        class="flex-shrink-0"
                      >
                        <img
                          class="w-8 h-8 rounded-full"
                          src="./image/logoHQ.png"
                          alt="ChatGPT Icon"
                        />
                      </div>
                      <div
                        v-if="message.role !== 'user'"
                        class="flex-1 min-w-0"
                      >
                        <p
                          class="text-sm text-gray-800 break-normal whitespace-pre-line"
                        >
                          <span
                            v-if="message.role === 'assistant'"
                            class="font-bold"
                            >Trợ lý:
                          </span>
                          <span
                            v-html="formatMessageWithLinks(message.content)"
                          ></span>
                        </p>
                        <!-- Biểu tượng loa để đọc nội dung -->
                        <button
                          v-if="message.role === 'assistant'"
                          @click="speakMessage(message.content)"
                          class="text-gray-500 hover:text-gray-700 ml-2 text-[10px]"
                          aria-label="Đọc nội dung"
                        >
                          <i class="fas fa-volume-up fa-lg"></i>
                        </button>
                      </div>
                    </div>
                  </li>
                </ul>

                <!-- Chat Input -->
                <form @submit.prevent="sendMessage">
                  <div class="flex space-y-2 sm:space-y-0 sm:space-x-3">
                    <div class="w-[90%]">
                      <textarea
                        v-model="userInput"
                        placeholder="Điền câu hỏi của bạn..."
                        class="flex-1 w-full h-auto p-2 mr-1 rounded-md shadow-sm resize-none"
                        rows="1"
                        @keyup.enter="sendMessage"
                        @focus="showSuggestions = true; showAllSuggestions()"
                        @input="filterSuggestions"
                      ></textarea>
                      <div
                        v-if="showSuggestions && filteredSuggestions.length > 0"
                        class="suggestions"
                      >
                        <div
                          v-for="suggestion in filteredSuggestions"
                          :key="suggestion"
                          @click="selectSuggestion(suggestion)"
                          class="suggestion-item"
                        >
                          {{ suggestion }}
                        </div>
                      </div>
                    </div>
                    <button
                      type="submit"
                      class="flex items-center px-4 py-2 text-black rounded-md bg-amber-200 hover:bg-amber-300 h-[40px]"
                    >
                      <img
                        class="w-4 h-4"
                        src="./image/send-svgrepo-com.svg"
                        alt="Send Icon"
                      />
                      Gửi
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Hình ảnh bên phải -->
      <!-- <div class="fixed right-0 top-0 h-full w-[0%] sm:w-1/6 md:w-1/5 xl:w-1/4">
        <img
          src="./image/sanphamHQ2.jpg"
          alt="Right Image"
          class="object-cover w-full h-full"
        />
      </div> -->

      <!-- Popup cài đặt -->
    </main>

    <script>
      const { createApp, ref, nextTick, computed, onMounted, onBeforeUnmount } =
        Vue;

      const apiKey = "app-wXpmjKnU0uOREHtZ5mapFl2h";

      createApp({
        setup() {
          const userInput = ref("");
          const messages = ref([]);
          const isLoading = ref(false);
          const showPopup = ref(false);
          const settingsText = ref("");
          const isFirstMessage = ref(true); // Biến cờ để theo dõi tin nhắn đầu tiên
          const isTyping = ref(false);
          const conversationId = ref("");
          const parentMessageId = ref("");

          const urlParams = new URLSearchParams(window.location.search);
          const question = urlParams.get("question");

          const showSuggestions = ref(false); // Show suggestions flag
          const suggestions = ref([]);

          function loadSuggestions() {
            switch (question) {
              case "AI_XU_LY":
                suggestions.value = [
                  "Cho tôi cách xử lý lời từ chối khi tuyển sỉ",
                  "Các mẫu câu từ chối thông dụng trong kinh doanh",
                  "Cách giải thích khi không đáp ứng được yêu cầu của khách",
                  "Kỹ năng xử lý tình huống từ chối khách hàng",
                  "Quy trình xử lý đơn hàng không hợp lệ",
                ];
                break;
              case "AI_PHAP_LUAT":
                suggestions.value = [
                  "Các quy định pháp lý về kinh doanh sỉ",
                  "Thủ tục đăng ký kinh doanh cần thiết",
                  "Quyền lợi và nghĩa vụ của đại lý",
                  "Hướng dẫn về hợp đồng đại lý",
                  "Chính sách bảo vệ quyền lợi khách hàng",
                ];
                break;
              case "AI_KE_HOACH":
                suggestions.value = [
                  "Làm thế nào để lập kế hoạch tuyển đại lý hiệu quả?",
                  "Các bước xây dựng chiến lược phát triển hệ thống",
                  "Cách tính toán chỉ tiêu doanh số cho đại lý",
                  "Phương pháp đánh giá tiềm năng thị trường",
                  "Lập kế hoạch phát triển vùng thị trường mới",
                ];
                break;
              case "AI_KICH_BAN":
                suggestions.value = [
                  "Cho tôi cách nghiên cứu chiến lược tuyển sỉ của đối thủ",
                  "Cách trình bày về sản phẩm và chính sách đại lý",
                  "Xử lý các câu hỏi thường gặp từ khách hàng",
                  "Kịch bản đàm phán điều khoản hợp tác",
                  "Các bước chốt hợp đồng đại lý",
                ];
                break;
              case "AI_NGHIEN_CUU":
                suggestions.value = [
                  "Phân tích điểm mạnh điểm yếu của đối thủ cạnh tranh",
                  "So sánh chính sách bán hàng với đối thủ",
                  "Cách thu thập thông tin về đối thủ",
                  "Chiến lược cạnh tranh hiệu quả",
                  "Xây dựng lợi thế cạnh tranh bền vững",
                ];
                break;
              case "AI_CONTENT":
                suggestions.value = [
                  "Tạo nội dung quảng cáo tuyển đại lý hấp dẫn",
                  "Cho tôi kịch bản tuyển sỉ trong 90 ngày",
                  "Các mẫu bài viết tuyển đại lý hiệu quả",
                  "Chiến lược đăng bài trên các kênh social media",
                  "Tối ưu nội dung cho từng nền tảng",
                ];
                break;
              case "AI_TRUYEN_CAM_HUNG":
                suggestions.value = [
                  "Cách tạo động lực cho đội ngũ bán hàng",
                  "Xây dựng văn hóa đội nhóm tích cực",
                  "Tổ chức các hoạt động team building hiệu quả",
                  "Kỹ năng lãnh đạo và truyền cảm hứng",
                  "Phát triển tinh thần đồng đội",
                ];
                break;
              case "AI_PHAN_BAN_HANG":
                suggestions.value = [
                  "Xây dựng phễu bán hàng chuyên nghiệp",
                  "Các bước trong quy trình chuyển đổi khách hàng",
                  "Tối ưu hóa tỷ lệ chuyển đổi",
                  "Quản lý và theo dõi hiệu quả phễu bán hàng",
                  "Chiến lược nurturing leads hiệu quả",
                ];
                break;
              case "AI_KICH_NEO":
                suggestions.value = [
                  "Thiết lập mục tiêu và KPI cho đội ngũ",
                  "Cách tạo động lực thông qua mục tiêu",
                  "Xây dựng hệ thống thưởng phạt hiệu quả",
                  "Đánh giá và phát triển năng lực nhân viên",
                  "Quản lý hiệu suất đội nhóm",
                ];
                break;
              case "AI_COACHING":
                suggestions.value = [
                  "Phương pháp coaching hiệu quả",
                  "Kỹ năng đặt câu hỏi và lắng nghe",
                  "Thiết lập và theo dõi mục tiêu cá nhân",
                  "Phát triển kế hoạch hành động",
                  "Đánh giá và điều chỉnh mục tiêu",
                ];
                break;
              default:
                // Default suggestions if question does not match predefined categories
                suggestions.value = [
                  "What is the capital of France?",
                  "How do I cook rice?",
                  "What is the weather like today?",
                  "Tell me a joke.",
                ];
            }

            // Show all suggestions initially
            filteredSuggestions.value = [...suggestions.value];
          }

          const filteredSuggestions = ref([]);

          // Filter suggestions based on user input
          function filterSuggestions() {
            if (!userInput.value.trim()) {
              filteredSuggestions.value = suggestions.value; // Show all if input is empty
              return;
            }
            filteredSuggestions.value = suggestions.value.filter((suggestion) =>
              suggestion.toLowerCase().includes(userInput.value.toLowerCase())
            );
          }
          // Show all suggestions when input is focused
          function showAllSuggestions() {
            console.log("Showing all suggestions");
            filteredSuggestions.value = [...suggestions.value];
            showSuggestions.value = true;
          }

          // Select a suggestion
          function selectSuggestion(suggestion) {
            userInput.value = suggestion;
            showSuggestions.value = false; // Hide suggestions after selection
          }

          // Hide suggestions when clicking outside
          function handleClickOutside(event) {
            console.log("test");
            const inputArea = document.querySelector("textarea");
            const suggestionsBox = document.querySelector(".suggestions");

            // If the click is outside of the input or suggestion box, hide the suggestions
            if (
              inputArea &&
              suggestionsBox &&
              !inputArea.contains(event.target) &&
              !suggestionsBox.contains(event.target)
            ) {
              showSuggestions.value = false;
            }
          }

          // Mount event listener to detect outside clicks
          onMounted(() => {
            loadSuggestions();
            document.addEventListener("click", handleClickOutside);
          });

          // Cleanup event listener on component unmount
          onBeforeUnmount(() => {
            document.removeEventListener("click", handleClickOutside);
          });

          const messageClasses = (role) => ({
            "text-right justify-end": role === "user",
            "text-left justify-start": role === "assistant",
          });

          // Phương thức tạo cuộc trò chuyện

          async function sendMessage() {
            if (!userInput.value.trim()) return;

            const contentInput = userInput.value;
            userInput.value = "";

            try {
              // Append user message
              messages.value.push({
                role: "user",
                content: contentInput,
              });

              // Add an initial message for the assistant
              const allMessages = [
                ...messages.value.map((msg) => ({
                  role: msg.role,
                  content: msg.content,
                })),
              ];

              // Gửi tin nhắn sau khi đã tạo cuộc trò chuyện
              const data = {
                inputs: {}, // Chỉnh sửa nếu cần thiết cho các biến khác
                query: contentInput, // Nội dung tin nhắn từ người dùng
                response_mode: "streaming",
                conversation_id: conversationId.value || "",
                parent_message_id: parentMessageId.value || "",
                user: "Dify", // Bạn có thể thay đổi giá trị này
              };

              const response = await fetch(
                "https://dify.phoenixtech.vn/v1/chat-messages",
                {
                  method: "POST",
                  headers: {
                    Authorization: `Bearer ${apiKey}`,
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(data),
                }
              );

              userInput.value = "";

              const reader = response.body.getReader();
              const decoder = new TextDecoder();
              let result = "";

              // Add an initial message for the assistant
              // Add an initial message for the assistant
              const assistantMessageIndex = messages.value.length;
              messages.value.push({
                role: "assistant",
                content: "",
              });

              // Process the streaming response
              while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                result += decoder.decode(value, { stream: true });

                // Process and update the content
                const contentChunks = result
                  .split("\n")
                  .filter((line) => line.trim());

                for (const chunk of contentChunks) {
                  const jsonChunks = chunk
                    .split("data: ")
                    .filter((part) => part.trim());

                  for (const jsonChunk of jsonChunks) {
                    try {
                      const data = JSON.parse(jsonChunk);

                      switch (data.event) {
                        case "agent_message":
                          const content = data.answer || "";
                          // Loại bỏ dấu *
                          const textContent = content.replace(/\*/g, "");
                          // Update the last assistant message with the new content
                          const lastMessage =
                            messages.value[assistantMessageIndex];
                          lastMessage.content += textContent;

                          nextTick(() => {
                            // Cuộn xuống khi có tin nhắn mới
                            const chatBox = document.querySelector(".chat-box");
                            if (chatBox) {
                              chatBox.scrollTop = chatBox.scrollHeight;
                            }
                          });
                          break;

                        case "agent_thought":
                          console.log("Agent Thought:", data.thought);
                          // Optionally handle agent thoughts
                          break;

                        case "tts_message":
                          console.log("TTS Message:", data.audio);
                          // Handle TTS message and play audio if needed
                          break;

                        case "tts_message_end":
                          console.log("TTS Message End");
                          // Handle the end of TTS message if needed
                          break;

                        case "message_end":
                          console.log("Message End");
                          isTyping.value = false;
                          break;

                        case "error":
                          console.error("Error:", data.message);
                          // Handle error event
                          isTyping.value = false;
                          break;

                        case "message_file":
                          // Handle file messages if needed
                          break;

                        case "message_replace":
                          // Handle message replacement if needed
                          break;

                        default:
                          console.log("Unknown event type:", data.event);
                      }
                      // Lưu conversation_id nếu chưa có
                      if (!conversationId.value && data.conversation_id) {
                        conversationId.value = data.conversation_id;
                        console.log(
                          "Lưu conversation_id:",
                          conversationId.value
                        );
                      }

                      // Lưu message_id để sử dụng cho parent_message_id ở tin nhắn tiếp theo
                      if (data.message_id) {
                        parentMessageId.value = data.message_id;
                        console.log(
                          "Cập nhật parentMessageId:",
                          parentMessageId.value
                        );
                      }
                    } catch (error) {
                      console.error("Error parsing JSON chunk", error);
                    }
                  }
                }

                console.log(messages.value);

                // Clear the result after processing
                result = "";
              }
            } catch (error) {
              console.error("There was an error with the API request", error);
            } finally {
              isLoading.value = false;
              isTyping.value = false; // Kết thúc trạng thái gõ chữ
            }
          }

          function speakMessage(message) {
            if (window.responsiveVoice) {
              responsiveVoice.speak(message, "Vietnamese Female"); // Bạn có thể thay đổi giọng đọc và ngôn ngữ theo nhu cầu
            } else {
              console.error("ResponsiveVoice is not loaded");
            }
          }

          function toggleSettingsPopup() {
            showPopup.value = !showPopup.value;
          }

          function closeSettingsPopup() {
            showPopup.value = false;
          }

          function saveSettings() {
            // Lưu giá trị từ textarea vào biến settingsText
            settingsText.value = settingsText.value.trim();
            console.log("settingsText.value", settingsText.value);
            closeSettingsPopup();
          }

          function formatMessageWithLinks(content) {
            // Decode HTML entities if content is encoded
            content = content.replace(/&lt;/g, "<").replace(/&gt;/g, ">");

            // Remove invalid or nested <a> tags
            content = content.replace(/<a\s+href="<a\s+href="/g, '<a href="');
            content = content.replace(/""\s*target="_blank".*?<\/a>/g, "");

            // Handle Markdown links
            content = content.replace(
              /\[([^\]]+)\]\(([^)]+)\)/g,
              (match, text, url) => {
                const cleanUrl = url.trim().replace(/["']/g, "");
                return `<a href="${cleanUrl}" target="_blank" class="text-blue-600 hover:underline">${text}</a>`;
              }
            );

            // Handle plain URLs
            const urlRegex = /https?:\/\/[^\s"<>]+[a-zA-Z0-9]/g;
            content = content.replace(urlRegex, (url) => {
              // Check if URL is already within an <a> tag
              if (/<a.*?>.*?<\/a>/.test(content)) {
                return url;
              }
              // Clean URL and return anchor tag
              const cleanUrl = url.trim().replace(/["']/g, "");
              return `<a href="${cleanUrl}" target="_blank" class="text-blue-600 hover:underline">${cleanUrl}</a>`;
            });

            // Handle bold Markdown (**text**)
            content = content.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

            return content;
          }

          const handleBack = () => {
            // selectedTopic.value = key;
            window.location.href = `index.html`;
          };

          return {
            formatMessageWithLinks,
            userInput,
            messages,
            messageClasses,
            sendMessage,
            isLoading,
            speakMessage,
            toggleSettingsPopup,
            closeSettingsPopup,
            saveSettings,
            showPopup,
            settingsText,
            isTyping,
            showSuggestions,
            filteredSuggestions,
            selectSuggestion,
            filterSuggestions,
            showAllSuggestions,
            handleBack,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
